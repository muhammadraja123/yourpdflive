<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PDF Editor ‚Äì YourPDFLive</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<!-- PDF.js -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
</script>

<!-- Fabric.js -->
<script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>

<style>
  :root{
    --red:#e11d48; --red-700:#be123c; --bg:#ffffff; --ink:#0f172a;
    --muted:#64748b; --panel:#f8fafc; --line:#e2e8f0;
  }
  *{box-sizing:border-box}
  body{ margin:0; background:var(--bg); color:var(--ink); font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
  header{ display:flex; align-items:center; gap:16px; padding:14px 20px; border-bottom:1px solid var(--line); }
  .wrap{ display:grid; grid-template-columns:84px 1fr 280px; min-height:calc(100vh - 60px); }
  .tools{ background:#fff; border-right:1px solid var(--line); padding:10px; display:flex; flex-direction:column; gap:10px; }
  .btn{ display:flex; align-items:center; justify-content:center; gap:8px; border:1px solid var(--line); background:#fff; color:var(--ink); height:40px; border-radius:10px; padding:0 10px; cursor:pointer; font-weight:600; transition:.15s; }
  .btn.icon{ width:100%; height:44px; padding:0; }
  .btn.solid{ background:var(--red); color:#fff; border-color:var(--red); }
  .btn:hover{ transform:translateY(-1px) }
  .btn.active,.btn.solid:hover{ background:var(--red-700); color:#fff; border-color:var(--red-700); }
  .stage{ background:var(--panel); display:flex; flex-direction:column; align-items:center; overflow:auto; padding:26px; }
  .page{ position:relative; background:#fff; box-shadow:0 20px 40px rgba(2,6,23,.10); border:1px solid var(--line); margin:18px 0; }
  .page canvas{ display:block }
  .status{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; background:rgba(255,255,255,.95); border:1px solid var(--line); padding:8px 12px; border-radius:8px; font-size:12px; color:var(--muted); box-shadow:0 6px 14px rgba(2,6,23,.08); display:none }
  .side{ border-left:1px solid var(--line); background:#fff; padding:14px; display:flex; flex-direction:column; gap:12px; }
  .group{ border:1px solid var(--line); padding:10px; border-radius:12px; background:#fff; }
  .group h3{ margin:0 0 8px 0; font-size:12px; text-transform:uppercase; letter-spacing:.12em; color:var(--muted) }
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
  input[type="color"]{ width:40px; height:32px; padding:0; border:1px solid var(--line); border-radius:8px; }
  input[type="number"]{ width:76px; height:32px; border:1px solid var(--line); border-radius:8px; padding:0 8px; }
  textarea{ width:100%; min-height:110px; resize:vertical; border:1px solid var(--line); border-radius:10px; padding:8px; font-family:inherit; }
  .thumbs{ display:flex; gap:8px; overflow:auto; padding:10px 0; }
  .thumb{ border:1px solid var(--line); border-radius:8px; overflow:hidden; background:#fff }
  .hint{ font-size:12px; color:var(--muted) }
</style>
</head>
<body>

<header>
  <button class="btn solid" id="btnUpload">Upload PDF</button>
  <input type="file" id="file" accept="application/pdf" hidden />
  <div class="hint">Click any object to edit. Press <b>Delete</b> to remove.</div>
</header>

<div class="wrap">
  <div class="tools" id="tools">
    <button class="btn icon solid" data-tool="select" title="Select/Move">üñ±Ô∏è</button>
    <button class="btn icon" data-tool="text" title="Text">üÖ£</button>
    <button class="btn icon" data-tool="pen" title="Freehand">‚úèÔ∏è</button>
    <button class="btn icon" data-tool="rect" title="Rectangle">‚ñ≠</button>
    <button class="btn icon" data-tool="ellipse" title="Ellipse">‚óØ</button>
    <button class="btn icon" data-tool="image" title="Image">üñºÔ∏è</button>
    <button class="btn icon" data-tool="sign" title="Signature">‚úçÔ∏è</button>
    <button class="btn icon" data-tool="whiteout" title="Whiteout/Redact">‚¨ú</button>
    <button class="btn icon" id="btnOCR" title="Scan & Edit (OCR)">üîé</button>
    <button class="btn icon" id="btnUndo" title="Undo">‚Ü∂</button>
    <button class="btn icon" id="btnRedo" title="Redo">‚Ü∑</button>
    <button class="btn icon" id="btnDownload" title="Download">‚¨áÔ∏è</button>
  </div>

  <div class="stage" id="stage">
    <div class="hint">Upload a PDF to start editing.</div>
  </div>

  <aside class="side">
    <div class="group">
      <h3>Text Style</h3>
      <div class="row">
        <button class="btn" id="bBold">Bold</button>
        <button class="btn" id="bItalic">Italic</button>
        <label class="hint">Size</label>
        <input type="number" id="fontSize" value="18" min="6" max="120" />
        <label class="hint">Color</label>
        <input type="color" id="fontColor" value="#111827" />
      </div>
    </div>

    <div class="group">
      <h3>Fill & Stroke</h3>
      <div class="row">
        <label class="hint">Fill</label>
        <input type="color" id="fillColor" value="#000000" />
        <label class="hint">Stroke</label>
        <input type="color" id="strokeColor" value="#000000" />
      </div>
    </div>

    <div class="group">
      <h3>Scan to Text (OCR)</h3>
      <div class="row"><button class="btn" id="btnOcrCurrent">Scan Current Page</button></div>
      <textarea id="ocrText" placeholder="Recognized text appears here. Click 'Insert as Text' to place it on the page."></textarea>
      <div class="row"><button class="btn" id="btnOcrInsert">Insert as Text</button></div>
    </div>

    <div class="group">
      <h3>Zoom</h3>
      <div class="row">
        <button class="btn" id="btnZoomOut">‚Äì</button>
        <button class="btn" id="btnZoomIn">+</button>
      </div>
    </div>

    <div class="group">
      <h3>Pages</h3>
      <div class="thumbs" id="thumbs"></div>
    </div>
  </aside>
</div>

<div class="status" id="status"></div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const stage = $('#stage'), fileInput = $('#file'), btnUpload = $('#btnUpload');
const btnDownload = $('#btnDownload'), btnUndo = $('#btnUndo'), btnRedo = $('#btnRedo');
const btnOCR = $('#btnOCR'), btnOcrCurrent = $('#btnOcrCurrent'), btnOcrInsert = $('#btnOcrInsert');
const ocrText = $('#ocrText'), statusEl = $('#status'), thumbs = $('#thumbs');

let pdfBytesBase64 = null, pdf = null, zoom = 1.15;
const pages = []; // [{pdfCanvas, fabric, container}]

function toast(msg, ms=1600){ statusEl.textContent = msg; statusEl.style.display='block'; setTimeout(()=>statusEl.style.display='none',ms); }
function setActiveTool(name){ $$('.tools .btn').forEach(b => b.classList.toggle('active', b.dataset.tool===name)); }
function activeFabric(){ const p = pages.find(p => p.container.classList.contains('active')); return p ? p.fabric : null; }
function selectPage(i){ pages.forEach((p,idx)=>p.container.classList.toggle('active', idx===i)); }

btnUpload.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  const arr = new Uint8Array(await file.arrayBuffer());
  pdfBytesBase64 = 'data:application/pdf;base64,' + btoa(String.fromCharCode(...arr));
  toast('Loading PDF‚Ä¶');
  pdf = await pdfjsLib.getDocument(arr).promise;
  stage.innerHTML = ''; pages.length = 0; thumbs.innerHTML = '';

  for (let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const viewport = page.getViewport({ scale: zoom });

    const container = document.createElement('div');
    container.className = 'page active';
    container.style.width = viewport.width + 'px';
    container.style.height = viewport.height + 'px';

    const pdfCanvas = document.createElement('canvas');
    pdfCanvas.width = viewport.width; pdfCanvas.height = viewport.height;
    container.appendChild(pdfCanvas);
    await page.render({ canvasContext: pdfCanvas.getContext('2d'), viewport }).promise;

    const fabricCanvas = new fabric.Canvas(document.createElement('canvas'), {
      width: viewport.width, height: viewport.height, selection: true
    });
    fabricCanvas.upperCanvasEl.style.position='absolute';
    fabricCanvas.upperCanvasEl.style.left='0'; fabricCanvas.upperCanvasEl.style.top='0';
    container.appendChild(fabricCanvas.upperCanvasEl);

    stage.appendChild(container);

    const t = document.createElement('canvas');
    const s = 120 / viewport.width; t.width = 120; t.height = viewport.height * s;
    t.getContext('2d').drawImage(pdfCanvas, 0, 0, t.width, t.height);
    const td = document.createElement('div'); td.className='thumb'; td.appendChild(t);
    td.addEventListener('click', () => selectPage(i-1)); thumbs.appendChild(td);

    pages.push({ pdfCanvas, fabric: fabricCanvas, container });
  }
  selectPage(0); toast('Ready. Choose a tool to start editing.');
});

// tools
const toolsEl = $('#tools'); let currentTool = 'select'; setActiveTool(currentTool);
toolsEl.addEventListener('click', e=>{
  const btn = e.target.closest('.btn'); if(!btn || !btn.dataset.tool) return;
  currentTool = btn.dataset.tool; setActiveTool(currentTool);
  const fc = activeFabric(); if(!fc) return;
  fc.isDrawingMode = (currentTool === 'pen');
  if (currentTool === 'pen') { fc.freeDrawingBrush = new fabric.PencilBrush(fc); fc.freeDrawingBrush.width = 2.5; fc.freeDrawingBrush.color = $('#strokeColor').value; }
});

function placeCentered(obj){
  const fc = activeFabric(); if(!fc) return;
  obj.set({ left: fc.getWidth()/2, top: fc.getHeight()/2, originX:'center', originY:'center' });
  fc.add(obj).setActiveObject(obj); fc.requestRenderAll();
}

document.addEventListener('keydown', e=>{
  if(e.key === 'Delete' || e.key === 'Backspace'){
    const fc = activeFabric(); if(!fc) return;
    const a = fc.getActiveObject(); if (a) { fc.remove(a); fc.requestRenderAll(); }
  }
});

// style controls
$('#bBold').onclick = ()=>{ const fc = activeFabric(), o = fc?.getActiveObject(); if(o?.type==='i-text'){ o.set({ fontWeight: o.fontWeight==='bold'?'normal':'bold' }); fc.requestRenderAll(); } };
$('#bItalic').onclick = ()=>{ const fc = activeFabric(), o = fc?.getActiveObject(); if(o?.type==='i-text'){ o.set({ fontStyle: o.fontStyle==='italic'?'normal':'italic' }); fc.requestRenderAll(); } };
$('#fontSize').oninput = e=>{ const fc = activeFabric(), o = fc?.getActiveObject(); if(o?.type==='i-text'){ o.set({ fontSize:+e.target.value }); fc.requestRenderAll(); } };
$('#fontColor').oninput = e=>{ const fc = activeFabric(), o = fc?.getActiveObject(); if(o?.type==='i-text'){ o.set({ fill:e.target.value }); fc.requestRenderAll(); } };
$('#fillColor').oninput = e=>{ const fc = activeFabric(), o = fc?.getActiveObject(); if(o && o.set){ o.set({ fill:e.target.value }); fc.requestRenderAll(); } };
$('#strokeColor').oninput = e=>{ const fc = activeFabric(), o = fc?.getActiveObject(); if(o && o.set){ o.set({ stroke:e.target.value, strokeWidth:2 }); fc.requestRenderAll(); } };

// double-click tool to add item
toolsEl.addEventListener('dblclick', ()=>{
  const fc = activeFabric(); if(!fc) return;
  switch(currentTool){
    case 'text':
      placeCentered(new fabric.IText('Edit me', { fontSize:+$('#fontSize').value, fill:$('#fontColor').value }));
      break;
    case 'rect':
      placeCentered(new fabric.Rect({ width:180, height:110, fill:'#ffffff00', stroke:$('#strokeColor').value, strokeWidth:2, rx:8, ry:8 }));
      break;
    case 'ellipse':
      placeCentered(new fabric.Ellipse({ rx:90, ry:60, fill:'#ffffff00', stroke:$('#strokeColor').value, strokeWidth:2 }));
      break;
    case 'whiteout':
      placeCentered(new fabric.Rect({ width:240, height:80, fill:'#ffffff', stroke:'#ffffff', strokeWidth:0, opacity:1, selectable:true }));
      break;
    case 'image': {
      const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
      inp.onchange = () => { const f = inp.files?.[0]; if(!f) return;
        const url = URL.createObjectURL(f);
        fabric.Image.fromURL(url, img=>{ img.set({ scaleX:0.5, scaleY:0.5 }); placeCentered(img); }, { crossOrigin:'anonymous' });
      }; inp.click(); break;
    }
    case 'sign': {
      const fc = activeFabric(); fc.isDrawingMode = true; currentTool='pen'; setActiveTool('pen'); toast('Draw signature, then press Esc.');
      const stop=(ev)=>{ if(ev.key==='Escape'){ fc.isDrawingMode=false; document.removeEventListener('keydown',stop); toast('Signature placed.'); } };
      document.addEventListener('keydown', stop); break;
    }
  }
});

// zoom
$('#btnZoomIn').onclick = async ()=>{ zoom*=1.1; await rerenderZoom(); };
$('#btnZoomOut').onclick = async ()=>{ zoom/=1.1; await rerenderZoom(); };
async function rerenderZoom(){
  if(!pdf) return; toast('Zooming‚Ä¶');
  for (let i=0;i<pdf.numPages;i++){
    const page = await pdf.getPage(i+1);
    const v = page.getViewport({ scale: zoom });
    const P = pages[i];
    P.container.style.width = v.width+'px'; P.container.style.height = v.height+'px';
    P.pdfCanvas.width = v.width; P.pdfCanvas.height = v.height;
    P.fabric.setWidth(v.width); P.fabric.setHeight(v.height);
    await page.render({ canvasContext:P.pdfCanvas.getContext('2d'), viewport:v }).promise;
  } toast('Zoom updated');
}

// undo/redo (simple undo)
btnUndo.onclick = ()=>{ const fc = activeFabric(); if(!fc) return; const objs = fc.getObjects(); const last = objs.pop(); if (last){ fc.remove(last); fc.requestRenderAll(); } };
btnRedo.onclick = ()=>{}; // optional to implement

// OCR
async function ocrPage(idx){
  const P = pages[idx], dataUrl = P.pdfCanvas.toDataURL('image/png');
  toast('Scanning (OCR)‚Ä¶');
  const resp = await fetch('/ocr', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ imageBase64:dataUrl, lang:'eng' }) });
  const j = await resp.json(); ocrText.value = (j?.text||'').trim(); toast(ocrText.value ? 'OCR complete' : 'No text recognized');
}
btnOCR.onclick = ()=> ocrPage( pages.findIndex(p=>p.container.classList.contains('active')) );
btnOcrCurrent.onclick = ()=> btnOCR.click();
btnOcrInsert.onclick = ()=>{ const fc = activeFabric(); if(!fc) return; if(!ocrText.value.trim()) return toast('Nothing to insert'); placeCentered(new fabric.IText(ocrText.value.trim(), { fontSize:+$('#fontSize').value, fill:$('#fontColor').value, lineHeight:1.2 })); };

// download (flatten overlays)
btnDownload.addEventListener('click', async ()=>{
  if (!pdfBytesBase64) return toast('Upload a PDF first');
  toast('Flattening edits‚Ä¶');
  const overlays = pages.map((P, idx)=>({ pageIndex: idx, dataUrl: P.fabric.toDataURL({ format:'png', multiplier:1 }) }));
  const resp = await fetch('/export', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ pdfBase64: pdfBytesBase64, overlays }) });
  if(!resp.ok) return toast('Export failed');
  const blob = await resp.blob(); const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='edited.pdf'; a.click(); URL.revokeObjectURL(url); toast('Downloaded edited.pdf');
});
</script>
</body>
</html>
